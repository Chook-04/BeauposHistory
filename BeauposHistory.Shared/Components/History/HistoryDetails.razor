
<div class="modal-content-container">
    <div class="modal-header">
        <button type="button" class="custom-close-btn" @onclick="OnClose">
            <i class="oi oi-x"></i>
        </button>
        <span class="invoice-title">#@Receipt?.ReceiptNo</span>
        @* <i class="oi oi-globe"></i> *@
    </div>
    <div class="modal-body @(Receipt?.IsVoided == true ? "view-only-mode" : "")">
        <div class="receipt-section">


            @if (IsNumpadVisible)
            {
                <div class="numpad-view-container">
                    <div class="details-header">
                        <button class="back-link" @onclick="() => IsNumpadVisible = false"><i class="oi oi-chevron-left"></i></button>
                        <span class="title">@SelectedPaymentForNumpad?.MethodName</span>
                        <div class="space"></div>
                    </div>


                    <div class="numpad-display-screen">
                        @(string.IsNullOrEmpty(NumpadBuffer) ? "0.00" : NumpadBuffer)
                    </div>

                    <div class="numpad-buttons-grid">
                        @foreach (var key in new[] { "1", "2", "3", "4", "5", "6", "7", "8", "9", "CLR", "0", "." })
                        {
                            <button class="numpad-btn">@key</button>
                            @* @onclick="() => HandleNumpadPress(key)" *@
                        }
                    </div>

                    <button class="numpad-action-save" @onclick="SaveNumpadValue">Save</button>
                </div>
            }
            else if (IsEditingPayment)
            {
                <div class="payment-edit-view">
                    <div class="details-header">
                        <button class="back-link" @onclick="() => IsEditingPayment = false">
                            <i class="oi oi-chevron-left"></i>
                        </button>
                        <span class="title">Payment</span>
                        <button class="save-link">Save</button>
                        @* @onclick="SavePayment" *@
                    </div>

                    <div class="payment-summary-header text-center">
                        <div class="main-total">@Receipt?.TotalSales.ToString("N2")</div>
                        <div class="difference-text">Difference: @PaymentDifference.ToString("N2")</div>
                    </div>

                    <div class="payment-methods-list">
                        @foreach (var pay in (Receipt?.Payments ?? new List<PaymentMethodDM>()).Where(x => x.Amount >= 0))
                        {
                            <div class="payment-input-group d-flex align-items-center justify-content-between">

                                <div class="method-label-group d-flex align-items-center">
                                    <button class="remove-payment-btn" @onclick:stopPropagation>
                                        @* @onclick="() => RemovePayment(pay)" *@
                                        <i class="oi oi-circle-x"></i>
                                    </button>
                                    <span class="method-name ml-2" @onclick="() => OpenNumpad(pay)">@pay.MethodName</span>
                                </div>

                                <div class="payment-value-clickable" @onclick="() => OpenNumpad(pay)">
                                    <span class="static-amount">@pay.Amount.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="other-methods-section">
                        <div class="section-title">Others</div>
                        <div class="other-methods-grid">
                            @foreach (var methodName in AvailableMethods.Where(m => !Receipt?.Payments.Any(p => p.MethodName == m) ?? false))
                            {
                                <button class="method-btn">
                                    @* @onclick="() => AddPayment(methodName)" *@
                                    @methodName
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
            else if (IsSelectingCashier)
            {
                <div class="select-cashier-view">
                    <div class="details-header">
                        <button class="back-link" @onclick="() => IsSelectingCashier = false">
                            <i class="oi oi-chevron-left"></i>
                        </button>
                        <span class="title">Select Staff</span>
                        <button class="done-link" @onclick="() => IsSelectingCashier = false">Done</button>
                    </div>

                    <div class="search-container">
                        <i class="oi oi-magnifying-glass"></i>
                        <input type="text" placeholder="Search" />
                        @* @bind-value="StaffSearchKeyword" @bind-value:event="oninput" *@
                    </div>

                    <div class="staff-grid">
                        @* No Staff 选项 *@
                        <div class="staff-card no-staff-active" @onclick="() => SelectCashier(null)">
                            <div class="staff-avatar gray-bg"><i class="oi oi-person"></i></div>
                            <div class="staff-info"><span class="staff-name">No Staff</span></div>
                        </div>

                        @foreach (var staff in FilteredStaffs)
                        {
                            <div class="staff-card" @onclick="() => SelectCashier(staff)">
                                <div class="staff-avatar">
                                    @if (!string.IsNullOrEmpty(staff.PhotoUrl))
                                    {
                                        <img src="@staff.PhotoUrl" />
                                    }
                                    else
                                    {

                                        <i class="oi oi-image"></i>
                                    }
                                </div>
                                <div class="staff-info">
                                    <span class="staff-name">@staff.Name</span>
                                    <span class="staff-phone">@staff.PhoneNumber</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (IsBackdateSaleEditing)
            {
                <div class="backdate-full-view">
                    <div class="calendar-nav-header">
                        <button class="back-link" @onclick="() => IsBackdateSaleEditing = false">
                            <i class="oi oi-chevron-left"></i>
                        </button>
                        <span class="nav-title">Backdate Sale</span>
                    </div>

                    <div class="month-control-bar">
                        <span class="month-label">@DisplayMonth.ToString("MMMM yyyy") ></span>
                        <div class="arrows">
                            <i class="oi oi-chevron-left arrow-icon" @onclick='() => DisplayMonth = DisplayMonth.AddMonths(-1)'></i>
                            @if (DisplayMonth.Year < DateTime.Today.Year || DisplayMonth.Month < DateTime.Today.Month)
                            {
                                <i class="oi oi-chevron-right arrow-icon" @onclick='() => DisplayMonth = DisplayMonth.AddMonths(1)'></i>
                            }
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div class="weekdays-row">
                            <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                        </div>
                        <div class="days-grid">
                            @foreach (var day in GetCalendarDays())
                            {
                                if (day == null)
                                {
                                    <div class="day-item empty"></div>
                                }
                                else
                                {
                                    bool isFuture = day.Value.Date > DateTime.Today;
                                    bool isSelected = day.Value.Date == SelectedDate?.Date;

                                    <div class="day-item @(isSelected ? "selected" : "") @(isFuture ? "disabled" : "")"
                                         @onclick="() => { if (!isFuture) SelectDate(day.Value); }">
                                        @day.Value.Day
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
            else if (SelectedService == null)
            {
                <div class="user-info-card">
                    <div class="avatar">
                        @* 之后可以绑定 Staff.PhotoUrl *@
                        <img src="path-to-avatar.png" alt="Avatar" />
                    </div>
                    <div class="user-details">
                        <span class="user-name">@Staff?.Name</span>
                        <span class="user-phone">@Staff?.PhoneNumber</span>
                    </div>
                </div>

                <div class="section-title">Backdate Sale</div>
                <div class="datetime-card @(Receipt?.IsVoided == true ? "voided-mode" : "")">
                    <div class="datetime-content">
                        @* 第一行：原始交易时间 *@
                        <div class="datetime-text">
                            @Receipt?.TransactionDate.ToString("hh:mm tt, dd/MM/yyyy")
                        </div>

                        @* 第二行：只有作废了才显示当前时间 *@
                        @if (Receipt?.IsVoided == true)
                        {
                            <div class="datetime-text void-time">
                                @Receipt.VoidedDate.ToString("hh:mm tt, dd/MM/yyyy")
                            </div>
                        }
                    </div>

                    <div class="datetime-action">
                        @if (!Receipt?.IsVoided == true)
                        {
                            <button class="edit-link backdate-sale" @onclick="EnterEditBackdateSale" @onclick:stopPropagation>Edit</button>
                        }
                        else
                        {
                            <span class="void-status-tag">Voided</span>
                        }
                    </div>
                </div>

                @* <div class="section-title">SERVICE</div> *@

                <div class="service-list">
                    @* 第一步：根据 Category 分组 *@
                    @foreach (var group in (Receipt?.Items ?? new List<ServiceItemDM>()).GroupBy(i => i.Category))
                    {
                        @* 第二步：显示 Category Label *@
                        <div class="category-header">
                            @group.Key @* 直接拿 Category 的名字 *@
                        </div>

                        @* 第三步：遍历该组下的所有服务项目 *@
                        @foreach (var service in group)
                        {
                            <div class="service-card-group">
                                <div class="service-item clickable-row" @onclick="() => SelectedService = service">
                                    <div class="service-icon">
                                        <i class="oi oi-image"></i>
                                    </div>
                                    <div class="service-info">
                                        <span class="service-name">@service.ItemName</span>
                                        <span class="service-price">@service.Price.ToString("N2")</span>
                                        @if (service.OutstandingAmount > 0)
                                        {
                                            <span class="payment-footer text-danger">
                                                Outstanding: @service.OutstandingAmount.ToString("N2")
                                            </span>
                                        }
                                    </div>
                                    <div class="service-qty">@service.Quantity</div>
                                </div>

                                @if (service.ServedByStaffs != null && service.ServedByStaffs.Any())
                                {
                                    <div class="staff-display-area">
                                        <div class="staff-grid-header">
                                            <span class="lbl-staff">Staff</span>
                                            <span class="lbl-effort">Effort</span>
                                            <span class="lbl-hof">H.O.F</span>
                                        </div>

                                        @foreach (var staff in service.ServedByStaffs)
                                        {
                                            <div class="staff-grid-row">
                                                <span class="val-name">@staff.Name</span>
                                                <span class="val-effort">
                                                    @((service.Price).ToString("N2"))
                                                    <span class="percent">(@staff.EffortPercentage.ToString("0.00")%)</span>
                                                </span>
                                                <span class="val-hof">@staff.HofPercentage.ToString("N2")</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>

                <div class="section-title">BILLS</div>
                <div class="info-card bills-card">
                    <div class="info-row">
                        <span class="label">Cashier</span>

                        @if (!string.IsNullOrWhiteSpace(Receipt?.CashierName) && Receipt.CashierName != "No Staff")
                        {
                            <span class="value cashier-name-display" @onclick="EnterSelectCashier">
                                @Receipt.CashierName
                            </span>
                        }
                        else
                        {
                            <button class="add-link" @onclick="EnterSelectCashier" @onclick:stopPropagation>
                                Add
                            </button>
                        }
                    </div>
                    <div class="info-row separator-top">
                        <span class="label">Quantity</span>
                        <span class="value">@Receipt?.Items.Sum(s => s.Quantity)</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Subtotal</span>
                        <span class="value">@Receipt?.TotalSales.ToString("N2")</span>
                    </div>
                    @if (Receipt?.OutstandingBalance > 0)
                    {
                        <div class="info-row">
                            <span class="label outstanding-text">Outstanding</span>
                            <span class="value outstanding-amount">@Receipt.OutstandingBalance.ToString("N2")</span>
                        </div>
                    }
                    <div class="info-row total-row">
                        <span class="label bold-text">Total</span>
                        <span class="value bold-amount">@Receipt?.Payments.Sum(x => x.Amount).ToString("N2")</span>
                    </div>
                </div>

                <div class="section-title">PAYMENT</div>

                <div class="info-card payment-card">
                    @if (Receipt?.Payments?.Any() == true)
                    {
                        <div class="payment-card-body d-flex flex-wrap gap-3">
                            @foreach (var pay in Receipt.Payments)
                            {
                                <div class="payment-item-box">
                                    <div class="payment-method-label">@pay.MethodName</div>
                                    <div class="payment-amount-value">@pay.Amount.ToString("N2")</div>
                                </div>
                            }
                            <button class="edit-link payment" @onclick="EnterEditPayment" @onclick:stopPropagation>Edit</button>
                        </div>
                    }
                    else
                    {
                        <span class="text-muted">No payment recorded</span>
                    }
                </div>

                <div class="section-title">REMARKS</div>
                <div class="input-field remarks-field">
                    <textarea placeholder="Add your remarks here..."
                              @bind="Receipt?.Remarks"
                              @bind:event="oninput"
                              @onclick:stopPropagation
                              rows="3"></textarea>
                </div>

                <div class="section-title">STAFF FINES</div>
                <div class="staff-fines-field">
                    <span class="lbl-staff">@Staff?.Name</span>
                    <span class="lbl-fines">1.00</span>
                </div>

                @* 底部的 Void 按钮也需要根据状态禁用 *@
                <div class="void-section">
                    <div class="member-id">
                        @if (Member?.MemberId != null)
                        {
                            <span>#@Member.MemberId</span>
                        }
                    </div>

                    @if (!Receipt.IsVoided)
                    {
                        @if (!showConfirmButtons)
                        {
                            <button class="void-btn" @onclick="() => showConfirmButtons = true" @onclick:stopPropagation>
                                Void Order
                            </button>
                        }
                        else
                        {
                            <div class="confirm-actions">
                                <span class="confirm-text">Confirm Void?</span>
                                <button class="btn-yes" @onclick="OnConfirmVoid">Yes</button>
                                <button class="btn-no" @onclick="() => showConfirmButtons = false">No</button>
                            </div>
                        }
                    }
                    else
                    {
                        <button class="void-btn disabled" disabled>Order Voided</button>
                    }
                </div>
            }
            else
            {
                @* 详情视图 (Item Details) *@
                <div class="item-details-view">
                    <div class="details-header">
                        <button class="back-link" @onclick="() => SelectedService = null">
                            <i class="oi oi-chevron-left"></i>
                        </button>
                        <span class="title">Item Details</span>
                        <button class="save-link" @onclick="() => SelectedService = null">Save</button>
                    </div>

                    <div class="service-item static">
                        <div class="service-icon">
                            <i class="oi oi-image"></i>
                        </div>
                        <div class="service-info">
                            <span class="service-name">@SelectedService.ItemName</span>
                            <span class="service-price">@SelectedService.Price.ToString("N2")</span>
                        </div>
                        <div class="service-qty">@SelectedService.Quantity</div>
                    </div>

                    <div class="add-staff-row-container">
                        @* @onclick="OpenSelectStaffModal" *@
                        <div class="add-staff-content">
                            <span class="add-label">Add Staff</span>
                            <i class="oi oi-loop-circular sync-icon"></i>
                        </div>
                    </div>

                    <div class="selected-staff-list">
                        @foreach (var staff in SelectedService.ServedByStaffs)
                        {
                            <div class="staff-detail-card">
                                <div class="staff-main-info">
                                    <button class="remove-staff-icon-btn" @onclick:stopPropagation>
                                        @* @onclick="() => RemoveStaffFromItem(staff)" *@
                                        <i class="oi oi-circle-x"></i>
                                    </button>
                                    <div class="staff-avatar-sm">
                                        @if (!string.IsNullOrEmpty(staff.PhotoUrl))
                                        {
                                            <img src="@staff.PhotoUrl" />
                                        }
                                        else
                                        {
                                            <i class="oi oi-image"></i>
                                        }
                                    </div>
                                    <div class="staff-text">
                                        <span class="staff-name">@staff.Name</span>
                                        <span class="staff-phone">@staff.PhoneNumber</span>
                                    </div>
                                </div>

                                <div class="staff-stats">
                                    <div class="stat-group">
                                        <span class="stat-label">Effort</span>
                                        <span class="stat-percent">@staff.EffortPercentage.ToString("0")%</span>
                                        <span class="stat-value">@staff.Value.ToString("N2")</span>
                                    </div>
                                    <div class="stat-group">
                                        <span class="stat-label">H.O.F</span>
                                        <span class="stat-percent">@staff.HofPercentage.ToString("0")%</span>
                                        <span class="stat-value">0.00</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {

}
